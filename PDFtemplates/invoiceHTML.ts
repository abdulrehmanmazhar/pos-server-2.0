import userModel from "../models/user.model";
import ErrorHandler from "../utils/ErrorHandler";

export const invoiceHTML = async (billData: any) => {
  const { order, customer, billPayment, subTotal, discount, instructionNote, orderTaker } = billData;
  const { name, address, contact, udhar } = customer;
  const { cart, total, payment, createdBy } = order;

  // Fetch the username of the creator
  

  // Calculate remaining credit
  const credit = Number(udhar) - (Number(subTotal) - Number(billPayment));

  // Generate table rows dynamically based on the cart
  const cartRows = cart
    .map((item: any, index: number) => {
      const { product, qty } = item;
      const totalPrice = qty * product.price; // Calculate total price for the row
      return `
        <tr>
          <td>${index + 1}</td> <!-- Serial Number -->
          <td>${product.name} (${product.category})</td> <!-- Product Name & Category -->
          <td>${qty}</td> <!-- Quantity -->
          <td>${product.price.toFixed(2)}</td> <!-- Price per Unit -->
          <td>${totalPrice.toFixed(2)}</td> <!-- Total Price -->
        </tr>
      `;
    })
    .join("");

  const formattedDate = new Date().toLocaleDateString("en-GB");

  return `
  <!DOCTYPE html>
  <html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f8f9fa;
      }
      .invoice-container {
        width: 80%;
        margin: 20px auto;
        background: #fff;
        border: 1px solid #ddd;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }
      .header {
        text-align: center;
        margin-bottom: 20px;
      }
      .header img {
        max-width: 150px;
        margin-bottom: 10px;
      }
      .header h1 {
        margin: 0;
        font-size: 24px;
      }
      .details-container {
        display: flex;
        justify-content: space-between;
        margin-bottom: 20px;
      }
      .customer-details, .company-details {
        width: 48%;
      }
      .company-details {
        text-align: right;
      }
      .date {
        text-align: right;
        font-size: 14px;
        margin-bottom: 10px;
        font-weight: bold;
      }
      .table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }
      .table th, .table td {
        border: 1px solid #ddd;
        text-align: left;
        padding: 8px;
      }
      .table th {
        background-color: #f2f2f2;
      }
      .total-row {
        text-align: right;
        font-weight: bold;
        padding: 10px 0;
      }
        .invoice-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px;
}

.invoice-logo {
  width: 100px;
  height: auto;
}

    </style>
  </head>
  <body>
    <div class="invoice-container">
      <div class="header">
      <svg xmlns="http://www.w3.org/2000/svg" width="150" height="100" viewBox="0 0 512 512">
        <path d="M0 0 C1.10924063 4.08718222 1.37363697 8.14851358 1.6484375 12.359375 C1.76789811 14.05080466 1.8877016 15.74221014 2.0078125 17.43359375 C2.19145991 20.07218919 2.37241392 22.7108782 2.546875 25.35009766 C3.55900319 40.51764375 5.23752326 55.17078249 10.25 69.625 C10.55373535 70.51179443 10.8574707 71.39858887 11.17041016 72.31225586 C18.2579052 92.46172281 29.23959999 109.2644349 48 120 C48.68449219 120.391875 49.36898437 120.78375 50.07421875 121.1875 C72.63147827 132.53260498 104.00501269 129.92321107 128 125 C128.91604004 124.81727539 129.83208008 124.63455078 130.77587891 124.44628906 C155.72059785 119.3305006 179.68084893 110.54553573 203.375 101.375 C245.6867299 85.01368479 288.81428611 73.79745127 334 69 C335.19496094 68.86722656 336.38992188 68.73445313 337.62109375 68.59765625 C372.84204706 65.38775663 414.68028448 66.79571508 443.4921875 90.0078125 C453.99273443 99.33780666 460.93859698 108.53891044 465 122 C465.15625 124.94921875 465.15625 124.94921875 465 127 C461.25333026 125.53531917 459.9759638 123.71689096 457.9375 120.3125 C453.93307857 114.38698087 449.24635115 111.31944071 443 108 C442.18015625 107.55011719 441.3603125 107.10023438 440.515625 106.63671875 C388.64029402 80.6185015 310.0014622 95.87319378 258 113 C256.29046143 113.5583252 256.29046143 113.5583252 254.54638672 114.12792969 C224.96095246 123.85559288 196.6665961 135.55307928 168.59960938 149.03637695 C146.93617819 159.43736846 125.13651529 169.29983268 102 176 C100.80576416 176.35578125 100.80576416 176.35578125 99.58740234 176.71875 C87.90952397 180.05883694 76.24853448 180.3792196 64.1875 180.4375 C63.4476889 180.44394531 62.70787781 180.45039063 61.94564819 180.45703125 C48.47277928 180.52883569 35.75960009 178.66677306 22.9375 174.3125 C22.18855469 174.05903809 21.43960938 173.80557617 20.66796875 173.54443359 C-0.5033684 166.04175098 -17.29678945 151.24245431 -27 131 C-40.13506383 102.11622482 -39.27416441 74.7125636 -28.6875 45.0625 C-23.79046974 33.33132308 -17.37478741 22.36930853 -10.625 11.625 C-10.11316162 10.81015137 -9.60132324 9.99530273 -9.07397461 9.15576172 C-3.2233284 0 -3.2233284 0 0 0 Z " fill="#000000" transform="translate(47,132)"/>
<path d="M0 0 C2.43567297 1.89768772 4.73914563 3.86879232 7.01953125 5.94921875 C7.62796875 6.46613281 8.23640625 6.98304687 8.86328125 7.515625 C25.08090321 22.22205946 32.30910868 46.14974988 33.3671875 67.40234375 C34.01475319 91.2340435 26.46670784 111.74473681 11.01953125 129.94921875 C10.53871094 130.56410156 10.05789062 131.17898437 9.5625 131.8125 C-6.04994491 151.38429693 -32.73374133 163.56145244 -56.98046875 166.94921875 C-81.82279838 168.91726988 -105.85754575 165.11991364 -125.47265625 148.88671875 C-141.11177381 135.19654897 -151.87707871 119.00458231 -153.98046875 97.94921875 C-155.19864966 69.74905858 -151.45320126 45.30166596 -132.98046875 22.94921875 C-132.23796875 21.95921875 -131.49546875 20.96921875 -130.73046875 19.94921875 C-100.36470254 -15.72318621 -38.68591431 -26.61874838 0 0 Z M-91.25 27.6796875 C-104.04718815 44.46335863 -106.50267101 67.70286839 -104.29296875 88.07421875 C-101.99012296 104.0502114 -96.10544404 120.71811822 -82.98046875 130.94921875 C-72.56888984 137.55767925 -63.49376128 139.59974901 -51.12109375 137.453125 C-43.03023467 135.2293951 -36.59446363 131.18699084 -30.98046875 124.94921875 C-30.32046875 124.22734375 -29.66046875 123.50546875 -28.98046875 122.76171875 C-16.42696753 105.10835766 -14.43889345 81.02702468 -17.59375 60.08984375 C-20.49444203 44.93033601 -27.84431504 28.98346256 -40.85546875 20.07421875 C-57.72176242 10.60944424 -77.96578159 13.72669837 -91.25 27.6796875 Z " fill="#000000" transform="translate(241.98046875,58.05078125)"/>
<path d="M0 0 C0.87217163 -0.00095673 1.74434326 -0.00191345 2.64294434 -0.00289917 C4.47143629 -0.00357415 6.29993074 -0.00176797 8.12841797 0.00244141 C10.89946972 0.00779939 13.67035943 0.002473 16.44140625 -0.00390625 C18.23177118 -0.00324535 20.02213602 -0.00196393 21.8125 0 C22.62634155 -0.00202423 23.44018311 -0.00404846 24.27868652 -0.00613403 C40.33153291 0.05809541 40.33153291 0.05809541 42.40625 2.1328125 C42.61623646 3.60255283 42.76464779 5.08117283 42.88696289 6.56079102 C42.96697037 7.50169083 43.04697784 8.44259064 43.12940979 9.41200256 C43.21174362 10.43490891 43.29407745 11.45781525 43.37890625 12.51171875 C43.46627548 13.55351791 43.55364471 14.59531708 43.6436615 15.66868591 C43.92293702 19.01055725 44.19590575 22.35291053 44.46875 25.6953125 C44.65648723 27.95511254 44.84463283 30.2148787 45.03320312 32.47460938 C45.49563235 38.02695859 45.95287866 43.57971674 46.40625 49.1328125 C42.95526835 48.35855851 40.6979945 47.16925602 37.7734375 45.1484375 C36.88398438 44.54257812 35.99453125 43.93671875 35.078125 43.3125 C33.23672411 42.04203626 31.3955717 40.7712123 29.5546875 39.5 C12.32440443 27.76558308 -4.96071961 23.08911618 -25.85546875 26.34375 C-42.33126807 29.82140043 -55.92554934 37.29530313 -65.6328125 51.09375 C-76.72060925 68.27762624 -78.45379905 86.39439952 -74.59375 106.1328125 C-72.61729367 113.71710902 -69.30551782 119.90570227 -64.59375 126.1328125 C-64.14257812 126.74898438 -63.69140625 127.36515625 -63.2265625 128 C-54.7244719 138.80774228 -40.35989064 145.95274435 -26.87548828 147.91455078 C-13.90100939 149.15563618 -0.52802275 148.5228993 12.40625 147.1328125 C13.67673874 116.21986692 13.67673874 116.21986692 1.93359375 88.7109375 C-0.07430865 86.6362762 -2.33585381 84.92584771 -4.59375 83.1328125 C-4.59375 82.1428125 -4.59375 81.1528125 -4.59375 80.1328125 C0.54327768 79.72263745 5.6804071 79.31376703 10.81762695 78.90600586 C12.55821404 78.76767575 14.29877486 78.62901457 16.03930664 78.48999023 C48.09029716 75.93071541 48.09029716 75.93071541 61.40625 76.1328125 C59.62895574 79.92665218 57.30702889 83.14874542 54.84375 86.5234375 C50.86452907 93.74658854 51.08824997 101.34934855 51.15625 109.3828125 C51.16229248 110.52508301 51.16833496 111.66735352 51.17456055 112.84423828 C51.35999027 128.95302424 51.60462404 146.64407858 59.40625 161.1328125 C59.40625 162.1228125 59.40625 163.1128125 59.40625 164.1328125 C52.01783491 165.72352434 44.62318525 166.86279156 37.12890625 167.82421875 C35.38171547 168.04947487 35.38171547 168.04947487 33.59922791 168.27928162 C31.13616077 168.59476559 28.67282096 168.90812716 26.20922852 169.21948242 C22.53703676 169.68662567 18.86725829 170.17022492 15.19726562 170.65429688 C-21.97959009 175.43728507 -64.70093087 179.01765291 -96.66015625 155.46875 C-111.27690154 143.82985029 -120.76199487 126.70640936 -123.59375 108.1328125 C-125.30910358 84.80513979 -122.29805426 60.56878911 -106.46875 42.16015625 C-105.85 41.49113281 -105.23125 40.82210937 -104.59375 40.1328125 C-103.913125 39.35035156 -103.2325 38.56789062 -102.53125 37.76171875 C-77.67437257 10.84743086 -35.46691124 -0.08821523 0 0 Z " fill="#000000" transform="translate(407.59375,12.8671875)"/>
      </svg>
        <h2>Invoice OG Cola Sattar Enterprises Hafizabad</h2>
      </div>

      <div class="date">Date: ${formattedDate}</div>

      <div class="details-container">
        <!-- Customer Details -->
        <div class="customer-details">
          <h3>Customer Details</h3>
          <p><strong>Name:</strong> ${name}</p>
          <p><strong>Address:</strong> ${address}</p>
          <p><strong>Contact:</strong> ${contact}</p>
          <p><strong>Previous Dues:</strong> ${credit.toFixed(2)} PKR</p>
        </div>

        <!-- Company Details -->
        <div class="company-details">
          <p><strong>Contact:</strong> 03436768695</p>
          <p><strong>Sales Manager:</strong> Talha Ahsan</p>
          <p><strong>Order Taker:</strong> ${orderTaker}</p>
        </div>
      </div>

      <table class="table">
        <thead>
          <tr>
            <th>#</th>
            <th>Description</th>
            <th>Quantity</th>
            <th>Price Per Unit</th>
            <th>Total Price</th>
          </tr>
        </thead>
        <tbody>
          ${cartRows}
        </tbody>
        <tfoot>
          <tr>
            <td colspan="4" class="total-row">Total:</td>
            <td>${total?.toFixed(2)}</td>
          </tr>
          <tr>
            <td colspan="4" class="total-row">Discount:</td>
            <td>${discount?.toFixed(2)} PKR</td>
          </tr>
          <tr>
            <td colspan="4" class="total-row">Subtotal:</td>
            <td>${subTotal?.toFixed(2)} PKR</td>
          </tr>
          <tr>
            <td colspan="4" class="total-row">Payment:</td>
            <td>${billPayment?.toFixed(2)}</td>
          </tr>
          <tr>
            <td colspan="4" class="total-row">Remaining:</td>
            <td>${(subTotal - billPayment + credit).toFixed(2)} PKR</td>
          </tr>
        </tfoot>
      </table>

      <!-- Instruction Note -->
      <p style="margin-top: 20px; font-style: italic; color: #555;">${instructionNote}</p>
    </div>
  </body>
  </html>
  `;
};
